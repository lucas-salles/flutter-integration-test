name: Get version code

on:
  pull_request:
    branches:
      - main

jobs:
  tests:
    name: Get version code from Play Store
    runs-on: ubuntu-latest

    steps:
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2

      - name: Install fastlane
        run: gem install fastlane

      - name: Get latest Play Store version code
        id: android_version
        run: |
          LATEST_BUILD=$(fastlane supply \
            --package_name "com.lucassales.flutter_integration_test" \
            --json_key_data '${{ secrets.GOOGLE_PLAY_JSON_KEY_DEV }}' \
            --skip_upload_metadata \
            --skip_upload_changelogs \
            --skip_upload_images \
            --skip_upload_screenshots \
            --check_superseded_tracks true \
            --track internal \
            --json_output_dir .tmp_version | jq -r '.apkVersionCodes[0]')
          echo "playstore_version=$LATEST_BUILD" >> $GITHUB_ENV
          echo "playstore_version=$LATEST_BUILD" >> $GITHUB_OUTPUT