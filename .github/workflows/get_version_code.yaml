name: Get version code

on:
  pull_request:
    branches:
      - main

jobs:
  tests:
    name: Get version code from Play Store
    runs-on: ubuntu-latest

    steps:
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2

      - name: Install fastlane
        run: gem install fastlane

      # - name: Get latest Play Store version code
      #   id: android_version
      #   run: |
      #     LATEST_BUILD=$(fastlane run \
      #       google_play_track_version_codes \
      #       package_name:"com.lucassales.flutter_integration_test.dev" \
      #       json_key_data:'${{ secrets.GOOGLE_PLAY_JSON_KEY_DEV }}' \
      #       track:"internal" | grep -Eo '[0-9]+' | sort -nr | head -n1)

      #     echo "playstore_version=$LATEST_BUILD" >> $GITHUB_ENV
      #     echo "playstore_version=$LATEST_BUILD" >> $GITHUB_OUTPUT

      # - name: Print result
      #   run: echo "Latest Play Store versionCode is ${{ env.playstore_version }}"

      - name: Get version codes from Play Store
        id: playstore
        run: |
          echo "ðŸ” Buscando versÃµes na Play Store..."

          # Internal
          INTERNAL=$(fastlane run google_play_track_version_codes \
            package_name:"com.lucassales.flutter_integration_test.dev" \
            json_key_data:'${{ secrets.GOOGLE_PLAY_JSON_KEY_DEV }}' \
            track:"internal" \
            print_json:true | jq -r '.versionCodes | join(", ")')

          # Beta
          BETA=$(fastlane run google_play_track_version_codes \
            package_name:"com.lucassales.flutter_integration_test.dev" \
            json_key_data:'${{ secrets.GOOGLE_PLAY_JSON_KEY_DEV }}' \
            track:"beta" \
            print_json:true | jq -r '.versionCodes | join(", ")')

          # Production
          PROD=$(fastlane run google_play_track_version_codes \
            package_name:"com.lucassales.flutter_integration_test.dev" \
            json_key_data:'${{ secrets.GOOGLE_PLAY_JSON_KEY_DEV }}' \
            track:"production" \
            print_json:true | jq -r '.versionCodes | join(", ")')

          echo "ðŸ“¦ Internal track: $INTERNAL"
          echo "ðŸ“¦ Beta track: $BETA"
          echo "ðŸ“¦ Production track: $PROD"

          # Exporta para outputs
          echo "internal=$INTERNAL" >> $GITHUB_OUTPUT
          echo "beta=$BETA" >> $GITHUB_OUTPUT
          echo "production=$PROD" >> $GITHUB_OUTPUT